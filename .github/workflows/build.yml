name: Auto-Build mxonlive v4.8.1

on: [push, workflow_dispatch]

jobs:
  build-android:
    name: Auto-Generate & Build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-java@v3
        with:
          distribution: 'zulu'
          java-version: '17'
      - uses: subosito/flutter-action@v2
        with:
          channel: 'stable'

      # ---------------------------------------------------------
      # üî• STEP 1: BACKUP & REGENERATE ANDROID PROJECT üî•
      # ---------------------------------------------------------
      - name: Regenerate Android Folder
        run: |
          echo "Starting Auto-Generation Process..."
          
          # ‡ßß. Google Services ‡¶´‡¶æ‡¶á‡¶≤‡¶ü‡¶ø ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï‡¶Ü‡¶™ ‡¶∞‡¶æ‡¶ñ‡¶æ
          if [ -f android/app/google-services.json ]; then
            mv android/app/google-services.json google-services.json
            echo "Backup google-services.json: DONE"
          else
            echo "Warning: google-services.json not found in android/app/"
          fi

          # ‡ß®. ‡¶™‡ßÅ‡¶∞‡¶®‡ßã android ‡¶´‡ßã‡¶≤‡ßç‡¶°‡¶æ‡¶∞ ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶æ
          rm -rf android
          echo "Deleted old Android folder: DONE"

          # ‡ß©. ‡¶®‡¶§‡ßÅ‡¶® ‡¶´‡ßç‡¶∞‡ßá‡¶∂ Android ‡¶™‡ßç‡¶∞‡ßã‡¶ú‡ßá‡¶ï‡ßç‡¶ü ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡¶æ (Kotlin DSL)
          flutter create . --org com.mxonlive.tv --project-name mxonlive --platforms android
          echo "Generated fresh Android project: DONE"

          # ‡ß™. Google Services ‡¶´‡¶æ‡¶á‡¶≤ ‡¶∞‡¶ø‡¶∏‡ßç‡¶ü‡ßã‡¶∞ ‡¶ï‡¶∞‡¶æ
          if [ -f google-services.json ]; then
            mv google-services.json android/app/
            echo "Restored google-services.json: DONE"
          fi

      # ---------------------------------------------------------
      # üî• STEP 2: INJECT CONFIGURATIONS (Kotlin DSL Fix) üî•
      # ---------------------------------------------------------
      - name: Inject Permissions & Configs
        run: |
          echo "Injecting configurations into Kotlin DSL files..."

          # ‡ßß. Permissions (AndroidManifest.xml - Same for all)
          sed -i 's/<application/<uses-permission android:name="android.permission.INTERNET"\/>\n    <uses-permission android:name="android.permission.WAKE_LOCK"\/>\n    <uses-permission android:name="android.permission.ACCESS_NETWORK_STATE"\/>\n    <application/g' android/app/src/main/AndroidManifest.xml
          
          # ‡ß®. MinSDK ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ (23) - Targeting build.gradle.kts
          # Kotlin DSL ‡¶è ‡¶è‡¶ü‡¶ø 'minSdk = ...' ‡¶•‡¶æ‡¶ï‡ßá
          sed -i 's/flutter.minSdkVersion/23/g' android/app/build.gradle.kts

          # ‡ß©. Google Services Plugin ‡¶≠‡¶æ‡¶∞‡ßç‡¶∏‡¶® ‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶ï‡¶∞‡¶æ (settings.gradle.kts)
          # plugins ‡¶¨‡ßç‡¶≤‡¶ï‡ßá‡¶∞ ‡¶∂‡ßÅ‡¶∞‡ßÅ‡¶§‡ßá ‡¶≤‡¶æ‡¶á‡¶®‡¶ü‡¶ø ‡¶¢‡ßÅ‡¶ï‡¶ø‡ßü‡ßá ‡¶¶‡ßá‡¶ì‡ßü‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá
          sed -i 's/plugins {/plugins {\n    id("com.google.gms.google-services") version "4.4.0" apply false/g' android/settings.gradle.kts

          # ‡ß™. App Level Plugins ‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶ï‡¶∞‡¶æ (app/build.gradle.kts)
          # android application ‡¶™‡ßç‡¶≤‡¶æ‡¶ó‡¶ø‡¶® ‡¶è‡¶∞ ‡¶®‡¶ø‡¶ö‡ßá google services ‡¶™‡ßç‡¶≤‡¶æ‡¶ó‡¶ø‡¶® ‡¶¶‡ßá‡¶ì‡ßü‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá
          sed -i 's/id("com.android.application")/id("com.android.application")\n    id("com.google.gms.google-services")/g' android/app/build.gradle.kts

          # ‡ß´. Firebase Dependencies ‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶ï‡¶∞‡¶æ (app/build.gradle.kts)
          # dependencies ‡¶¨‡ßç‡¶≤‡¶ï‡ßá‡¶∞ ‡¶∂‡ßÅ‡¶∞‡ßÅ‡¶§‡ßá ‡¶≤‡¶æ‡¶á‡¶¨‡ßç‡¶∞‡ßá‡¶∞‡¶ø‡¶ó‡ßÅ‡¶≤‡ßã ‡¶¶‡ßá‡¶ì‡ßü‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá
          sed -i 's/dependencies {/dependencies {\n    implementation(platform("com.google.firebase:firebase-bom:32.7.0"))\n    implementation("com.google.firebase:firebase-analytics")/g' android/app/build.gradle.kts

          echo "All Kotlin DSL configurations injected successfully."

      # ---------------------------------------------------------
      # üî• STEP 3: BUILD üî•
      # ---------------------------------------------------------
      - name: Generate Icons
        run: |
          if [ ! -f assets/logo.png ]; then mkdir -p assets; curl -L -o assets/logo.png "https://cdn-icons-png.flaticon.com/512/3163/3163478.png"; fi
          flutter pub get
          dart run flutter_launcher_icons

      - name: Install Dependencies
        run: flutter pub get

      - name: Build Universal APK
        run: flutter build apk --release

      - name: Build Split APKs
        run: flutter build apk --release --split-per-abi

      - name: Bundle Results
        run: |
          mkdir -p release_apks
          cp build/app/outputs/flutter-apk/app-release.apk release_apks/mxonlive-v4.8.1-Universal.apk
          cp build/app/outputs/flutter-apk/app-arm64-v8a-release.apk release_apks/mxonlive-v4.8.1-Arm64.apk
          cd release_apks && zip -r mxonlive-v4.8.1-bundle.zip .

      - uses: actions/upload-artifact@v4
        with:
          name: mxonlive-v4.8.1-bundle
          path: release_apks/mxonlive-v4.8.1-bundle.zip
