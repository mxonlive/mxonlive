name: Full Reset Build - mxonlive v6.0

on:
  push:
  workflow_dispatch:

jobs:
  android-build:
    name: Full Clean & Rebuild
    runs-on: ubuntu-latest

    steps:
      # ğŸ“¥ CHECKOUT
      - name: Checkout Repository
        uses: actions/checkout@v3

      # â˜• JAVA
      - name: Setup Java 17
        uses: actions/setup-java@v3
        with:
          distribution: zulu
          java-version: '17'

      # ğŸ¦ FLUTTER
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable

      # ğŸ”¥ FULL RESET (NO SURVIVORS)
      - name: HARD RESET PROJECT
        run: |
          echo "ğŸ”¥ FULL PROJECT WIPE"
          rm -rf \
            android \
            ios \
            build \
            .dart_tool \
            .flutter-plugins \
            .flutter-plugins-dependencies
          flutter clean

      # ğŸ†• REGENERATE PROJECT
      - name: Recreate Flutter Project
        run: |
          flutter create . \
            --org com.mxonlive.tv \
            --project-name mxonlive

      # ğŸ”§ ANDROID FIXES
      - name: Inject Android Config
        run: |
          MANIFEST=android/app/src/main/AndroidManifest.xml

          sed -i 's/<application/<uses-permission android:name="android.permission.INTERNET"\/>\n    <uses-permission android:name="android.permission.WAKE_LOCK"\/>\n    <uses-permission android:name="android.permission.ACCESS_NETWORK_STATE"\/>\n    <application android:usesCleartextTraffic="true"/' $MANIFEST

          sed -i 's/flutter.minSdkVersion/21/g' android/app/build.gradle.kts

      # ğŸ“¦ BUILD
      - name: Build APKs
        run: |
          flutter pub get
          flutter build apk --release
          flutter build apk --release --split-per-abi

      # ğŸ“¤ UPLOAD
      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: mxonlive-v6.0-full-reset
          path: build/app/outputs/flutter-apk/*.apk
